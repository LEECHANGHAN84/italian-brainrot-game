{% extends "layout.html" %}
{% from "macros/quiz_ui.html" import render_quiz_ui %}
{% from "macros/stamp_macro.html" import stamp_system %}

{% block title %}ì´ˆì‹  ëª¨ë“œ{% endblock %}

{% block content %}
<style>
    /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ */
    .timer-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
    }
    #timer-bar-container {
        width: 200px;
        height: 15px;
        background-color: #e9ecef;
        border-radius: 8px;
        overflow: hidden;
    }
    #timer-bar {
        height: 100%;
        width: 100%;
        background-color: #17a2b8; /* info color */
        transition: width 1s linear;
    }
    /* ê²½ê³¼ ì‹œê°„ ìŠ¤íƒ€ì¼ */
    #elapsed-timer {
        font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        background: linear-gradient(45deg, #5f27cd, #ff6b6b);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    
    /* ì´ë¯¸ì§€ í´ë¦½ ìŠ¤íƒ€ì¼ */
    .character-image-wrapper {
        position: relative;
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
    }
    
    /* ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    
    /* ë©”ëª¨ë¦¬ ê²Œì„ ìŠ¤íƒ€ì¼ */
    .memory-game-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
        margin: 0 auto 20px;
        max-width: 500px;
        position: relative;
    }
    
    /* ë§¤ì¹˜ ì„±ê³µ íš¨ê³¼ */
    .match-success-effect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(76, 175, 80, 0.8);
        color: white;
        font-size: 2rem;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 10px;
        z-index: 100;
        animation: fadeInOut 0.8s ease-in-out;
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }
    
    .memory-card {
        position: relative;
        height: 200px;
        perspective: 1000px;
        cursor: pointer;
        transform-style: preserve-3d;
        transition: transform 0.6s, box-shadow 0.3s;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .memory-card:hover {
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        transform: translateY(-5px);
    }
    
    .memory-card.flipped {
        transform: rotateY(180deg);
    }
    
    .memory-card.matched {
        transform: rotateY(180deg);
        cursor: default;
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
        border: 3px solid #4CAF50;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
        100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    
    .memory-card-front,
    .memory-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .memory-card-front {
        background-color: white;
        transform: rotateY(180deg);
        overflow: hidden;
        padding: 8px;
    }
    
    .memory-card-back {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
        font-weight: bold;
    }
    
    .memory-card-back i {
        font-size: 3.5rem;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .memory-card-front img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }
    .image-container {
        position: relative;
        width: 100%;
        max-width: 300px;
        height: 300px;
        margin: 0 auto;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 18px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .image-container img,
    #character-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
    }
    
    /* ì´ë¯¸ì§€ ì¤Œ íš¨ê³¼ë¥¼ ìœ„í•œ CSS */
    .image-container.zoomed #character-image {
        transform: scale(2);
    }
    .image-container.zoomed[data-segment="0"] #character-image { transform-origin: top left; }
    .image-container.zoomed[data-segment="1"] #character-image { transform-origin: top right; }
    .image-container.zoomed[data-segment="2"] #character-image { transform-origin: bottom left; }
    .image-container.zoomed[data-segment="3"] #character-image { transform-origin: bottom right; }
</style>
    <!-- ì‚¬ìš©ì ì •ë³´ ì…ë ¥ í¼ -->
<div id="user-info-form" class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h3 class="mb-0"><i class="fas fa-crown me-2"></i> ì´ˆì‹  ëª¨ë“œ ë„ì „</h3>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <p class="lead">ë„ì „ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                    </div>
                    <form id="player-form" class="needs-validation" novalidate>
                        <!-- êµ­ê°€ ì„ íƒ ë¶€ë¶„ ì£¼ì„ ì²˜ë¦¬
                        <div class="mb-3">
                            <label for="country-select" class="form-label">êµ­ê°€ <i class="fas fa-flag"></i></label>
                            <select id="country-select" class="form-select" required>
                                <option value="South Korea" selected data-flag="kr">ëŒ€í•œë¯¼êµ­ ğŸ‡°ğŸ‡·</option>
                                <option value="Japan" data-flag="jp">ì¼ë³¸ ğŸ‡¯ğŸ‡µ</option>
                                <option value="China" data-flag="cn">ì¤‘êµ­ ğŸ‡¨ğŸ‡³</option>
                                <option value="United States" data-flag="us">ë¯¸êµ­ ğŸ‡ºğŸ‡¸</option>
                                <option value="United Kingdom" data-flag="gb">ì˜êµ­ ğŸ‡¬ğŸ‡§</option>
                                <option value="France" data-flag="fr">í”„ë‘ìŠ¤ ğŸ‡«ğŸ‡·</option>
                                <option value="Germany" data-flag="de">ë…ì¼ ğŸ‡©ğŸ‡ª</option>
                                <option value="Italy" data-flag="it">ì´íƒˆë¦¬ì•„ ğŸ‡®ğŸ‡¹</option>
                                <option value="Spain" data-flag="es">ìŠ¤í˜ì¸ ğŸ‡ªğŸ‡¸</option>
                                <option value="Canada" data-flag="ca">ìºë‚˜ë‹¤ ğŸ‡¨ğŸ‡¦</option>
                                <option value="Australia" data-flag="au">í˜¸ì£¼ ğŸ‡¦ğŸ‡º</option>
                                <option value="Brazil" data-flag="br">ë¸Œë¼ì§ˆ ğŸ‡§ğŸ‡·</option>
                                <option value="Russia" data-flag="ru">ëŸ¬ì‹œì•„ ğŸ‡·ğŸ‡º</option>
                                <option value="India" data-flag="in">ì¸ë„ ğŸ‡®ğŸ‡³</option>
                            </select>
                            <div class="invalid-feedback">êµ­ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
                        </div>
                        -->
                        <!-- êµ­ê°€ ì„ íƒ ëŒ€ì‹  ê¸°ë³¸ê°’ ì„¤ì • -->
                        <input type="hidden" id="country-select" value="South Korea">
                        <div class="mb-3">
                            <label for="affiliation-input" class="form-label">ì†Œì† <i class="fas fa-university"></i></label>
                            <input type="text" id="affiliation-input" class="form-control" placeholder="í•™êµ/íšŒì‚¬/ë‹¨ì²´ëª…" required>
                            <div class="invalid-feedback">ì†Œì†ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                        </div>
                        <div class="mb-3">
                            <label for="nickname-input" class="form-label">ë‹‰ë„¤ì„ <i class="fas fa-user-tag"></i></label>
                            <input type="text" id="nickname-input" class="form-control" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„" required>
                            <div class="invalid-feedback">ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" id="start-quiz-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-play-circle me-2"></i> ë„ì „ ì‹œì‘
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- í€´ì¦ˆ UI -->
<div id="quiz-container" style="display: none;">
    {% call render_quiz_ui('ì´ˆì‹  ëª¨ë“œ', show_timer=False) %}
        <div id="options-container" class="row g-3 col-10 mx-auto">
            <!-- Buttons will be inserted here by JavaScript -->
        </div>
    {% endcall %}
</div>
{% endblock %}

{% block scripts %}
{{ stamp_system() }}
<script>
    // --- DOM Elements ---
    const userInfoForm = document.getElementById('user-info-form');
    const quizContainer = document.getElementById('quiz-container');
    const playerForm = document.getElementById('player-form');
    const countrySelect = document.getElementById('country-select');
    const affiliationInput = document.getElementById('affiliation-input');
    const nicknameInput = document.getElementById('nickname-input');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    
    const scoreDisplay = document.getElementById('score');
    const quizArea = document.getElementById('quiz-area');
    const loadingScreen = document.getElementById('loading-screen');
    const resultScreen = document.getElementById('result-screen');
    const finalScoreDisplay = document.getElementById('final-score');
    const correctAnswersDisplay = document.getElementById('correct-answers');
    const totalQuestionsDisplay = document.getElementById('total-questions');
    const optionsContainer = document.getElementById('options-container');
    const imageContainer = document.querySelector('.image-container');
    const progressBar = document.getElementById('progress-bar');
    const timerSlot = document.getElementById('timer-slot');
    
    // --- Game State ---
    let score = 0;
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let timerInterval = null; // Timer interval ID
    let startTime = null; // í€´ì¦ˆ ì‹œì‘ ì‹œê°„
    
    // --- ì‚¬ìš©ì ì •ë³´ ---
    let playerCountry = 'South Korea';
    let playerAffiliation = '';
    let playerNickname = '';

    // --- Core Functions ---
    function createTimerUI() {
        if (document.getElementById('timer-container')) return;

        const timerContainer = document.createElement('div');
        timerContainer.id = 'timer-container';
        timerContainer.className = 'timer-container d-flex align-items-center';
        timerContainer.innerHTML = `
            <i class="fas fa-stopwatch me-2" style="color: #5f27cd;"></i>
            <span id="elapsed-timer" class="fw-bold">00:00</span>
        `;
        timerSlot.appendChild(timerContainer);
    }

    // í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    document.addEventListener('DOMContentLoaded', function() {
        playerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // í¼ ìœ íš¨ì„± ê²€ì‚¬
            if (!playerForm.checkValidity()) {
                e.stopPropagation();
                playerForm.classList.add('was-validated');
                return;
            }
            
            // ì‚¬ìš©ì ì •ë³´ ì €ì¥
            playerCountry = countrySelect.value;
            playerAffiliation = affiliationInput.value.trim();
            playerNickname = nicknameInput.value.trim();
            
            // í¼ ìˆ¨ê¸°ê³  í€´ì¦ˆ ì‹œì‘
            userInfoForm.style.display = 'none';
            quizContainer.style.display = 'block';
            startQuiz();
        });
    });
    
    async function startQuiz() {
        clearInterval(timerInterval);
        createTimerUI();
        loadingScreen.style.display = 'block';
        quizArea.style.display = 'none';
        resultScreen.style.display = 'none';
        try {
            const response = await fetch('/api/quiz/ultra_god'); // ì´ˆì‹  ëª¨ë“œ API ê²½ë¡œ
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            questions = await response.json();
            if (questions.length === 0) {
                throw new Error('í‘œì‹œí•  í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            // Reset state for a new game
            currentQuestionIndex = 0;
            score = 0;
            correctAnswers = 0;
            scoreDisplay.textContent = score;
            
            // í€´ì¦ˆ ì‹œì‘ ì‹œê°„ ê¸°ë¡
            startTime = new Date();
            // ê²½ê³¼ ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
            startElapsedTimer();
            
            loadingScreen.style.display = 'none';
            quizArea.style.display = 'block';
            showNextQuestion();
        } catch (error) {
            loadingScreen.innerHTML = `<p class="text-danger">${error.message}</p><a href="{{ url_for('index') }}" class="btn btn-primary">ë©”ì¸ìœ¼ë¡œ</a>`;
        }
    }

    function showNextQuestion() {
        if (currentQuestionIndex >= questions.length) {
            endQuiz();
            return;
        }
        const question = questions[currentQuestionIndex];
        console.log('í˜„ì¬ ë¬¸ì œ ìœ í˜•:', question.type, question);
        
        // ì´ë¯¸ì§€ ì˜ì—­ ì´ˆê¸°í™”
        imageContainer.innerHTML = '';
        optionsContainer.innerHTML = ''; // Clear previous options
        
        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ í‘œì‹œ (ê¸°ë³¸ê°’)
        document.querySelector('.image-container').style.display = 'flex';
        
        // ë¬¸ì œ ìœ í˜•ì— ë”°ë¼ ì´ë¯¸ì§€ í‘œì‹œ ë°©ì‹ ë³€ê²½
        if (question.type === 'image_crop') {
            console.log('ì´ë¯¸ì§€ í¬ë¡­ ë¬¸ì œ í‘œì‹œ');
            
            // ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
            const characterImage = document.createElement('img');
            characterImage.id = 'character-image';
            characterImage.alt = 'ìºë¦­í„° ì´ë¯¸ì§€';
            characterImage.src = `/static/uploads/${question.image}`;
            imageContainer.appendChild(characterImage);
            
            // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ì¤€ í´ë˜ìŠ¤ ì ìš©
            characterImage.onload = () => {
                const imageContainer = characterImage.closest('.image-container');
                // 4ê°œì˜ ì‚¬ë¶„ë©´ (0: TL, 1: TR, 2: BL, 3: BR)
                const segment = Math.floor(Math.random() * 4);
                imageContainer.dataset.segment = segment;
                imageContainer.classList.add('zoomed');
                question.applied_segment = segment; // ì ìš©ëœ ì„¸ê·¸ë¨¼íŠ¸ ì €ì¥
            };
            
            // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
            question.options.forEach((option, index) => {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'col-6 d-grid';

                const button = document.createElement('button');
                button.className = 'btn btn-lg btn-primary';
                button.textContent = `${index + 1}. ${option.name}`;
                button.dataset.answer = option.name; // ì •ë‹µ ë¹„êµë¥¼ ìœ„í•´ ë°ì´í„° ì†ì„± ì¶”ê°€
                button.onclick = () => checkAnswer(button, question.correct_answer); // ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ë°›ì€ ì •ë‹µ ì‚¬ìš©

                buttonWrapper.appendChild(button);
                optionsContainer.appendChild(buttonWrapper);
            });
            
        } else if (question.type === 'masked_text') {
            console.log('í…ìŠ¤íŠ¸ ë§ˆìŠ¤í‚¹ ë¬¸ì œ í‘œì‹œ');
            
            // ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„±
            const characterImage = document.createElement('img');
            characterImage.id = 'character-image';
            characterImage.alt = 'ìºë¦­í„° ì´ë¯¸ì§€';
            characterImage.src = `/static/uploads/${question.image}`;
            characterImage.className = 'img-fluid rounded';
            imageContainer.appendChild(characterImage);
            
            // ì„ íƒì§€ ë²„íŠ¼ ìƒì„± (ë§ˆìŠ¤í‚¹ ì ìš©)
            question.options.forEach((option, index) => {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'col-6 d-grid';

                const button = document.createElement('button');
                button.className = 'btn btn-lg btn-primary';
                
                // í…ìŠ¤íŠ¸ ë§ˆìŠ¤í‚¹ ì ìš©
                const displayText = maskText(option.name);
                button.dataset.maskedText = displayText;
                
                button.textContent = `${index + 1}. ${displayText}`;
                button.dataset.answer = option.name; // ì •ë‹µ ë¹„êµë¥¼ ìœ„í•´ ë°ì´í„° ì†ì„± ì¶”ê°€
                button.onclick = () => checkAnswer(button, question.correct_answer); // ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ë°›ì€ ì •ë‹µ ì‚¬ìš©

                buttonWrapper.appendChild(button);
                optionsContainer.appendChild(buttonWrapper);
            });
            
        } else if (question.type === 'memory_game') {
            console.log('ë©”ëª¨ë¦¬ ê²Œì„ ë¬¸ì œ í‘œì‹œ');
            
            // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸° (ë©”ëª¨ë¦¬ ê²Œì„ì—ì„œëŠ” ìƒë‹¨ ì´ë¯¸ì§€ ë¶ˆí•„ìš”)
            document.querySelector('.image-container').style.display = 'none';
            
            // ë©”ëª¨ë¦¬ ê²Œì„ ì»¨í…Œì´ë„ˆ ìƒì„±
            const memoryGameContainer = document.createElement('div');
            memoryGameContainer.className = 'memory-game-container';
            optionsContainer.appendChild(memoryGameContainer);
            
            // ë©”ëª¨ë¦¬ ê²Œì„ íƒ€ì´í‹€ ì¶”ê°€
            const memoryTitle = document.createElement('div');
            memoryTitle.className = 'text-center mb-3';
            memoryTitle.innerHTML = '<h4>ê°™ì€ ìºë¦­í„° ì¹´ë“œë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</h4>';
            optionsContainer.insertBefore(memoryTitle, memoryGameContainer);
            
            // ë©”ëª¨ë¦¬ ê²Œì„ ì¹´ë“œ ìƒì„±
            let flippedCards = [];
            let matchedPairs = 0;
            let canFlip = true;
            
            // ì¹´ë“œ ìƒì„± (4ì¥ì˜ ì¹´ë“œ, ëª¨ë‘ ê°™ì€ ìºë¦­í„°)
            question.cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-card';
                cardElement.dataset.cardId = card.id;
                
                // ì¹´ë“œ ì•ë©´ (ì´ë¯¸ì§€)
                const cardFront = document.createElement('div');
                cardFront.className = 'memory-card-front';
                const cardImage = document.createElement('img');
                cardImage.src = `/static/uploads/${card.image}`;
                cardImage.alt = card.name;
                cardFront.appendChild(cardImage);
                
                // ì¹´ë“œ ë’¤ë©´ (ë¬¼ìŒí‘œ)
                const cardBack = document.createElement('div');
                cardBack.className = 'memory-card-back';
                cardBack.innerHTML = '<i class="fas fa-question"></i>';
                
                // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
                cardElement.addEventListener('click', function() {
                    // ì´ë¯¸ ë’¤ì§‘íŒ ì¹´ë“œê±°ë‚˜ ë” ì´ìƒ ë’¤ì§‘ì„ ìˆ˜ ì—†ëŠ” ìƒíƒœë©´ ë¬´ì‹œ
                    if (!canFlip || this.classList.contains('flipped') || this.classList.contains('matched')) return;
                    
                    // ì´ë¯¸ 2ì¥ì´ ë’¤ì§‘í˜€ ìˆìœ¼ë©´ ë¬´ì‹œ
                    if (flippedCards.length >= 2) return;
                    
                    // ì¹´ë“œ ë’¤ì§‘ê¸°
                    this.classList.add('flipped');
                    flippedCards.push(this);
                    
                    // 2ì¥ì˜ ì¹´ë“œê°€ ë’¤ì§‘í˜”ì„ ë•Œ
                    if (flippedCards.length === 2) {
                        canFlip = false;
                        
                        // ë‘ ì¹´ë“œì˜ í˜ì–´ ID ê°€ì ¸ì˜¤ê¸°
                        const card1 = question.cards.find(c => c.id === flippedCards[0].dataset.cardId);
                        const card2 = question.cards.find(c => c.id === flippedCards[1].dataset.cardId);
                        
                        // ì ì‹œ ê¸°ë‹¤ë¦° í›„ ë§¤ì¹˜ í™•ì¸
                        setTimeout(() => {
                            // ê°™ì€ í˜ì–´ì¸ì§€ í™•ì¸
                            if (card1.pair_id === card2.pair_id) {
                                // ë§¤ì¹˜ ì„±ê³µ
                                flippedCards[0].classList.add('matched');
                                flippedCards[1].classList.add('matched');
                                
                                // ë§¤ì¹˜ ì„±ê³µ íš¨ê³¼ëŠ” ì œê±°í•˜ê³  ê¸°ë³¸ íš¨ê³¼ë§Œ ì‚¬ìš©
                                
                                matchedPairs++;
                                
                                // ëª¨ë“  í˜ì–´ê°€ ë§¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ (2í˜ì–´ = 4ì¥)
                                if (matchedPairs === 2) {
                                    // ë©”ëª¨ë¦¬ ê²Œì„ ì™„ë£Œ - ì •ë‹µ ì²˜ë¦¬
                                    setTimeout(() => {
                                        const dummyButton = document.createElement('button');
                                        // ë°±ì—”ë“œì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ë°›ì€ ì •ë‹µ ì‚¬ìš©
                                        const correctAnswer = question.correct_answer;
                                        dummyButton.dataset.answer = correctAnswer;
                                        checkAnswer(dummyButton, correctAnswer);
                                    }, 500);
                                }
                            } else {
                                // ë§¤ì¹˜ ì‹¤íŒ¨ - ì¹´ë“œ ë‹¤ì‹œ ë’¤ì§‘ê¸°
                                flippedCards[0].classList.remove('flipped');
                                flippedCards[1].classList.remove('flipped');
                            }
                            
                            // ë‹¤ìŒ ì„ íƒ ì¤€ë¹„
                            flippedCards = [];
                            canFlip = true;
                        }, 800);
                    }
                });
                
                // ì¹´ë“œ êµ¬ì„± ìš”ì†Œ ì¶”ê°€
                cardElement.appendChild(cardFront);
                cardElement.appendChild(cardBack);
                memoryGameContainer.appendChild(cardElement);
            });
            
            // ë©”ëª¨ë¦¬ ê²Œì„ì—ì„œëŠ” ì„ íƒì§€ ë²„íŠ¼ì´ í•„ìš” ì—†ìŒ
            
        } else {
            // ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œ ìœ í˜•ì¼ ê²½ìš° ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œ ìœ í˜•:', question.type);
            imageContainer.innerHTML = `<div class="alert alert-danger">ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œ ìœ í˜•: ${question.type}</div>`;
        }
        
        updateProgressBar();
        startElapsedTimer();
    }
    
    // ì´ì „ í´ë¦½ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ìƒˆë¡œìš´ ì¤€ ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´ë˜ì–´ ì‚­ì œí•¨
    
    // í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ë§ˆìŠ¤í‚¹í•˜ëŠ” í•¨ìˆ˜
    function maskText(text) {
        // ê¸€ìê°€ ë„ˆë¬´ ì§§ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (text.replace(/\s+/g, '').length < 4) {
            return text;
        }
        
        // ëœë¤í•˜ê²Œ 4ê¸€ì ì„ íƒí•  ìœ„ì¹˜ ì°¾ê¸°
        // ë„ì–´ì“°ê¸°ë¥¼ ì œì™¸í•œ ì‹¤ì œ ê¸€ìë§Œ ê³ ë ¤
        const charPositions = [];
        for (let i = 0; i < text.length; i++) {
            if (text[i] !== ' ') {
                charPositions.push(i);
            }
        }
        
        // ì „ì²´ ê¸€ì ìˆ˜ê°€ 4ê¸€ì ë¯¸ë§Œì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        if (charPositions.length < 4) {
            return text;
        }
        
        // ëœë¤í•˜ê²Œ 4ê¸€ì ì„ íƒ
        const selectedIndices = [];
        while (selectedIndices.length < 4) {
            const randomIndex = Math.floor(Math.random() * charPositions.length);
            const charPos = charPositions[randomIndex];
            
            // ì´ë¯¸ ì„ íƒëœ ìœ„ì¹˜ê°€ ì•„ë‹ˆë©´ ì¶”ê°€
            if (!selectedIndices.includes(charPos)) {
                selectedIndices.push(charPos);
            }
        }
        
        // ì •ë ¬í•˜ì—¬ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬
        selectedIndices.sort((a, b) => a - b);
        
        // ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
        let result = '';
        for (let i = 0; i < text.length; i++) {
            if (text[i] === ' ') {
                // ë„ì–´ì“°ê¸°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                result += ' ';
            } else if (selectedIndices.includes(i)) {
                // ì„ íƒëœ 4ê¸€ìëŠ” ê·¸ëŒ€ë¡œ í‘œì‹œ
                result += text[i];
            } else {
                // ë‚˜ë¨¸ì§€ ê¸€ìëŠ” 'O'ë¡œ ëŒ€ì²´
                result += 'O';
            }
        }
        
        return result;
    }

    function startElapsedTimer() {
        const elapsedTimer = document.getElementById('elapsed-timer');
        if (!elapsedTimer) return;
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
        clearInterval(timerInterval);
        
        // ê²½ê³¼ ì‹œê°„ í‘œì‹œ í•¨ìˆ˜
        function updateElapsedTime() {
            if (!startTime) return;
            
            const now = new Date();
            const elapsedMs = now - startTime;
            const totalSeconds = Math.floor(elapsedMs / 1000); // ì´ ì´ˆ ê³„ì‚°
            const milliseconds = Math.floor((elapsedMs % 1000) / 10); // ë°€ë¦¬ì´ˆë¥¼ 2ìë¦¬ë¡œ í‘œì‹œ
            
            elapsedTimer.textContent = `${totalSeconds}.${milliseconds.toString().padStart(2, '0')}`;
        }
        
        // ì´ˆê¸° ì‹œê°„ í‘œì‹œ
        updateElapsedTime();
        
        // 10ë°€ë¦¬ì´ˆë§ˆë‹¤ ê²½ê³¼ ì‹œê°„ ì—…ë°ì´íŠ¸ (100ms)
        timerInterval = setInterval(updateElapsedTime, 100);
    }

    function handleTimeout() {
        timerBar.style.transition = 'none';
        timerBar.style.width = '0%';
        score -= 10;
        scoreDisplay.textContent = score;
        showUnifiedStamp('ì‹œê°„ì´ˆê³¼ -10', false);

        const question = questions[currentQuestionIndex];
        
        // ë©”ëª¨ë¦¬ ê²Œì„ íƒ€ì…ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
        if (question.type === 'memory_game') {
            // ë©”ëª¨ë¦¬ ê²Œì„ì—ì„œ ì‹œê°„ ì´ˆê³¼ì‹œ ëª¨ë“  ì¹´ë“œ ë³´ì´ê¸°
            const memoryCards = document.querySelectorAll('.memory-card');
            memoryCards.forEach(card => {
                card.classList.add('flipped');
                card.classList.add('matched'); // í´ë¦­ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì„¤ì •
            });
            
            currentQuestionIndex++;
            setTimeout(showNextQuestion, 2000);
            return;
        }
        
        // ì¼ë°˜ ë¬¸ì œ íƒ€ì… ì²˜ë¦¬ (ì´ë¯¸ì§€ í¬ë¡­ ë˜ëŠ” ë§ˆìŠ¤í‚¹ëœ í…ìŠ¤íŠ¸)
        const allButtons = optionsContainer.querySelectorAll('button');
        
        // ë¬¸ì œ íƒ€ì…ì— ë”°ë¼ ì •ë‹µ ì²˜ë¦¬
        let correctAnswer = '';
        if (question.options && question.options.length > 0) {
            correctAnswer = question.options[0].name;
        }

        allButtons.forEach(btn => {
            btn.disabled = true;
            if (btn.dataset.answer === correctAnswer) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
            }
        });

        currentQuestionIndex++;
        setTimeout(showNextQuestion, 2000);
    }

    function checkAnswer(selectedButton, correctAnswer) {
        clearInterval(timerInterval); // Stop the timer

        const question = questions[currentQuestionIndex];
        
        // ë©”ëª¨ë¦¬ ê²Œì„ íƒ€ì…ì¸ ê²½ìš°
        if (question.type === 'memory_game') {
            // ë©”ëª¨ë¦¬ ê²Œì„ì€ ì´ë¯¸ ë§ì¶°ì„œ ì™„ë£Œí•œ ê²½ìš°ì´ë¯¸ë¡œ ë¬´ì¡°ê±´ ì •ë‹µ ì²˜ë¦¬
            score += 4;
            correctAnswers++;
            scoreDisplay.textContent = score;
            showUnifiedStamp('ì •ë‹µ +4', true);
            
            // ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
            setTimeout(() => {
                currentQuestionIndex++;
                showNextQuestion();
            }, 1500);
            
            return;
        }

        const allButtons = optionsContainer.querySelectorAll('button');
        const selectedAnswerName = selectedButton.dataset.answer;

        // ì´ë¯¸ì§€ í¬ë¡­ ë¬¸ì œì˜€ë‹¤ë©´ ì „ì²´ ì´ë¯¸ì§€ í‘œì‹œ
        if (question.type === 'image_crop') {
            const characterImage = document.getElementById('character-image');
            const imageContainer = characterImage.closest('.image-container');
            
            // ì¤€ í´ë˜ìŠ¤ ì œê±°
            imageContainer.classList.remove('zoomed');
            delete imageContainer.dataset.segment;
        }
        
        // í…ìŠ¤íŠ¸ ë§ˆìŠ¤í‚¹ ë¬¸ì œì˜€ë‹¤ë©´ ì›ë˜ í…ìŠ¤íŠ¸ ë³´ì´ê¸°
        if (question.type === 'masked_text') {
            // ëª¨ë“  ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µì›
            allButtons.forEach((btn, idx) => {
                const originalText = btn.dataset.answer;
                btn.textContent = `${idx + 1}. ${originalText}`;
            });
        }

        allButtons.forEach(btn => {
            btn.disabled = true;
            const btnName = btn.dataset.answer;
            if (btnName === correctAnswer) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
            }
        });

        if (selectedAnswerName === correctAnswer) {
            score += 4; // ì ìˆ˜ ë³€ê²½: 10ì  -> 4ì 
            correctAnswers++;
            scoreDisplay.textContent = score;
            showUnifiedStamp('ì •ë‹µ +4', true);
        } else {
            selectedButton.classList.remove('btn-primary');
            selectedButton.classList.add('btn-danger');
            score -= 8; // ì ìˆ˜ ë³€ê²½: 4ì  -> 8ì 
            scoreDisplay.textContent = score;
            showUnifiedStamp('ì˜¤ë‹µ -8', false);
        }
        
        // ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
        setTimeout(() => {
            currentQuestionIndex++;
            showNextQuestion();
        }, 1500);
    }

    function updateProgressBar() {
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
    }

    function endQuiz() {
        clearInterval(timerInterval);
        quizArea.style.display = 'none';
        resultScreen.style.display = 'block';
        finalScoreDisplay.textContent = score;
        correctAnswersDisplay.textContent = correctAnswers;
        totalQuestionsDisplay.textContent = questions.length;
        
        // ì ìˆ˜ ì €ì¥ API í˜¸ì¶œ
        const endTime = new Date();
        const timeTaken = (endTime - startTime) / 1000; // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        
        // ì ìˆ˜ ì €ì¥ API í˜¸ì¶œ
        fetch('/api/ultra_god_leaderboard/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                country: playerCountry,
                school: playerAffiliation,
                nickname: playerNickname,
                score: score,
                time_taken: timeTaken
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('ì ìˆ˜ ì €ì¥ ì„±ê³µ:', data);
        })
        .catch(error => {
            console.error('ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:', error);
        });
        
        const endButtons = document.getElementById('end-buttons');
        endButtons.innerHTML = '';

        // ë ˆë”ë³´ë“œ ë²„íŠ¼ ì¶”ê°€
        const leaderboardBtn = document.createElement('a');
        leaderboardBtn.href = "{{ url_for('ultra_god_leaderboard') }}";
        leaderboardBtn.className = 'btn btn-primary btn-lg me-3';
        leaderboardBtn.innerHTML = '<i class="fas fa-trophy me-2"></i> ëª…ì˜ˆì˜ ì „ë‹¹';
        endButtons.appendChild(leaderboardBtn);

        const restartBtn = document.createElement('a');
        restartBtn.href = "{{ url_for('ultra_god_mode') }}";
        restartBtn.className = 'btn btn-primary btn-lg me-3';
        restartBtn.innerHTML = '<i class="fas fa-redo me-2"></i> ë‹¤ì‹œí•˜ê¸°';
        endButtons.appendChild(restartBtn);

        const mainMenuBtn = document.createElement('a');
        mainMenuBtn.href = "{{ url_for('index') }}";
        mainMenuBtn.className = 'btn btn-secondary btn-lg';
        mainMenuBtn.innerHTML = '<i class="fas fa-home me-2"></i> ë©”ì¸ ë©”ë‰´ë¡œ';
        endButtons.appendChild(mainMenuBtn);
    }

    document.addEventListener('DOMContentLoaded', startQuiz);
</script>
{% endblock %}
